@{
    ViewData["Title"] = "Create Purchase Order";
}

<h3 class="mb-3">Create Purchase Order</h3>

<form asp-action="Create" method="post">

    <!-- SUPPLIER -->
    <input type="hidden" name="SupplierId" id="SupplierId" />

    <div class="mb-3">
        <label class="form-label">Supplier</label>
        <input type="text"
               id="SupplierSearch"
               class="form-control"
               placeholder="Ketik nama supplier..."
               autocomplete="off"
               required />
    </div>

    <!-- PO ITEMS -->
    <table class="table table-bordered" id="itemTable">
        <thead class="table-light">
            <tr>
                <th width="40%">Item</th>
                <th width="15%">Qty</th>
                <th width="20%">Price</th>
                <th width="20%">Subtotal</th>
                <th width="5%"></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button type="button"
            class="btn btn-outline-primary mb-3"
            onclick="addRow()">
        + Add Item
    </button>
    <div class="text-end">
    <button type="button"
            class="btn btn-warning mb-3"
            data-bs-toggle="modal"
                data-bs-target="#terminModal">
        💳 Atur Termin Pembayaran
    </button>
    </div>
    <div class="text-end mb-3">
        <h5>Total: <span id="grandTotal">0</span></h5>
    </div>

    <button type="submit"
        class="btn btn-success"
        onclick="return validateTerm()">Save Purchase Order</button>



    <a href="/PurchaseOrder" class="btn btn-secondary">
        Kembali
    </a>


    <!-- MODAL -->
    <div class="modal fade" id="terminModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Termin Pembayaran</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Termin</th>
                                <th>Jatuh Tempo</th>
                                <th>%</th>
                                <th>Amount</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="termBody">
                            <!-- ROW DIBUAT VIA JS -->
                        </tbody>
                    </table>

                    <button type="button" id="btnAddTerm" class="btn btn-primary">
                        + Tambah Termin
                    </button>

                    <div class="modal-footer">
                        <button type="button"
                                class="btn btn-secondary"
                                data-bs-dismiss="modal">
                            Batal
                        </button>

                        <button type="button"
                                class="btn btn-success"
                                onclick="saveTermsFromModal()">
                            Simpan Termin
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>

</form>


<table class="d-none">
    <tbody>
        <tr id="termTemplate">
            <td>
                <input type="text" class="form-control term-no" readonly>
            </td>
            <td>
                <input type="date" class="form-control due-date">
            </td>
            <td>
                <input type="number" class="form-control percentage" min="0" max="100">
            </td>
            <td>
                <input type="text" class="form-control amount" readonly />
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-danger btn-remove">✕</button>
            </td>
        </tr>
    </tbody>
</table>

<div class="text-end mt-3">
    <strong>Total: </strong>
    <span id="totalPercent">0</span>% |
    Rp <span id="totalAmount">0</span>
</div>



<!-- ========================= -->
<!-- SCRIPT DI FILE YANG SAMA -->
<!-- ========================= -->
@section Scripts {
    <script>
        /* ===================== GLOBAL STATE ===================== */
        let selectedItemIds = new Set();

        /* ===================== DOCUMENT READY ===================== */
        $(function () {

            /* ===== SUPPLIER AUTOCOMPLETE ===== */
            $("#SupplierSearch").autocomplete({
                minLength: 2,
                source: function (request, response) {
                    $.ajax({
                        url: '@Url.Action("SearchSupplier", "PurchaseOrder")',
                        dataType: "json",
                        data: { term: request.term },
                        success: function (data) {
                            response(data);
                        }
                    });
                },
                select: function (event, ui) {
                    $("#SupplierSearch").val(ui.item.label);
                    $("#SupplierId").val(ui.item.id);
                    return false;
                }
            });

        });

        /* ===================== ADD ROW ===================== */
        function addRow() {

            let row = `
            <tr>
                <td>
                    <input type="hidden" class="item-id" />
                    <input type="text"
                           class="form-control item-search"
                           placeholder="Ketik nama item..."
                           autocomplete="off" />
                </td>
                <td>
                    <input type="number"
                           class="form-control qty"
                           value="1" min="1" />
                </td>
                <td>
                    <input type="number"
                           class="form-control price"
                           value="0" min="0" />
                </td>
                <td>
                    <input type="text"
                           class="form-control subtotal"
                           readonly value="0" />
                </td>
                <td class="text-center">
                    <button type="button"
                            class="btn btn-danger btn-sm"
                            onclick="removeRow(this)">X</button>
                </td>
            </tr>`;

            $("#itemTable tbody").append(row);
            reindexRows();
            initItemAutocomplete();
        }

        /* ===================== ITEM AUTOCOMPLETE ===================== */
        function initItemAutocomplete() {

            $(".item-search").autocomplete({
                minLength: 2,
                source: function (request, response) {
                    $.ajax({
                        url: '@Url.Action("SearchItem", "PurchaseOrder")',
                        dataType: "json",
                        data: { term: request.term },
                        success: function (data) {
                            response(data);
                        }
                    });
                },
                        select: function (event, ui) {

            let row = $(this).closest("tr");
            let newItemId = String(ui.item.id);
            let supplierId = $("#SupplierId").val();

            if (!supplierId) {
                alert("Pilih supplier terlebih dahulu");
                return false;
            }

            let oldItemId = row.find(".item-id").val();
            if (oldItemId) selectedItemIds.delete(oldItemId);

            if (selectedItemIds.has(newItemId)) {
                alert("Item ini sudah dipilih di baris lain.");
                $(this).val("");
                row.find(".item-id").val("");
                return false;
            }

            selectedItemIds.add(newItemId);

            row.find(".item-search").val(ui.item.label);
            row.find(".item-id").val(newItemId);

            /* === AUTO LOAD HARGA TERAKHIR SUPPLIER === */
            $.get('@Url.Action("GetLastPrice", "PurchaseOrder")',
                { supplierId: supplierId, itemId: newItemId },
                function (price) {
                    row.find(".price").val(price);
                    calculateRow(row);
                });

            return false;
        }

            });
        }

        /* ===================== CALCULATION ===================== */
        $(document).on("keyup change", ".qty, .price", function () {
            calculateRow($(this).closest("tr"));
        });

        function calculateRow(row) {
            let qty = parseFloat(row.find(".qty").val()) || 0;
            let price = parseFloat(row.find(".price").val()) || 0;
            row.find(".subtotal").val((qty * price).toFixed(2));
            calculateGrandTotal();
        }

        function calculateGrandTotal() {
            let total = 0;
            $(".subtotal").each(function () {
                total += parseFloat($(this).val()) || 0;
            });
            $("#grandTotal").text(total.toFixed(2));
        }

        /* ===================== REMOVE ROW ===================== */
        function removeRow(btn) {
            let row = $(btn).closest("tr");
            let itemId = row.find(".item-id").val();

            if (itemId) {
                selectedItemIds.delete(itemId);
            }

            row.remove();
            reindexRows();
            calculateGrandTotal();
        }

        /* ===================== MODEL BINDING ===================== */
        function reindexRows() {
            $("#itemTable tbody tr").each(function (i) {
                $(this).find(".item-id").attr("name", `Items[${i}].ItemId`);
                $(this).find(".qty").attr("name", `Items[${i}].Qty`);
                $(this).find(".price").attr("name", `Items[${i}].Price`);
            });
        }


        //termin
        let termInitialized = false;

        // modal dibuka → hanya buat 1 row
        $('#terminModal').on('shown.bs.modal', function () {
            if (!termInitialized) {
                addTerm();
                termInitialized = true;
            }
        });

        // tombol tambah
        $("#btnAddTerm").on("click", function () {
            addTerm();
        });

        // hapus baris
        $("#termBody").on("click", ".btn-remove", function () {
            $(this).closest("tr").remove();
            reindexTerms();
        });

        function addTerm() {
            let row = $("#termTemplate").clone().removeAttr("id");
            $("#termBody").append(row);
            reindexTerms();
        }

        function reindexTerms() {
            $("#termBody tr").each(function (i) {

                $(this).find(".term-no")
                    .val(i + 1)
                    .attr("name", `Terms[${i}].TermNo`);

                $(this).find(".due-date")
                    .attr("name", `Terms[${i}].DueDate`);

                $(this).find(".percentage")
                    .attr("name", `Terms[${i}].Percentage`);

                $(this).find(".amount")
                    .attr("name", `Terms[${i}].amount`);
            });
        }

        /* ===== VALIDASI 100% ===== */
        function validateTerm() {

            let total = 0;

            $(".percentage").each(function () {
                total += parseFloat($(this).val()) || 0;
            });

            if (total > 0 && total !== 100) {
                alert("Total termin harus 100%");
                return false;
            }

            return true;
        }

            function saveTermsFromModal() {

            let total = 0;
            let valid = true;

            $("#termBody tr").each(function () {
                let percent = parseFloat($(this).find(".percentage").val()) || 0;
                let due = $(this).find(".due-date").val();

                total += percent;

                if (!due || percent <= 0) {
                    valid = false;
                }
            });

            if (!valid) {
                alert("Tanggal dan persentase termin wajib diisi.");
                return;
            }

            if (total !== 100) {
                alert("Total persentase termin harus 100%");
                return;
            }

            // ✔️ CUKUP TUTUP MODAL
            $("#terminModal").modal("hide");
        }

                function calculateTermAmount() {

            let grandTotal = parseFloat($("#grandTotal").text()) || 0;
            let totalPercent = 0;
            let totalAmount = 0;

            $("#termBody tr").each(function () {
                let percent = parseFloat($(this).find(".percentage").val()) || 0;
                let amount = grandTotal * percent / 100;

                totalPercent += percent;
                totalAmount += amount;

                $(this).find(".amount").val(amount.toLocaleString("id-ID"));
            });

            $("#totalPercent").text(totalPercent.toFixed(2));
            $("#totalAmount").text(totalAmount.toLocaleString("id-ID"));
        }

            $(document).on("keyup change", ".percentage", function () {
            calculateTermAmount();
        });


    </script>
}

