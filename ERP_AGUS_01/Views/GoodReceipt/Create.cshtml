@using System.Data
@{
    ViewData["Title"] = "Goods Receipt";
    var dt = Model as DataTable;
}

<h3 class="mb-3">
    <i class="bi bi-box-arrow-in-down"></i> Goods Receipt
</h3>

<form asp-action="Create" method="post" id="grForm">
    <input type="hidden" name="POId" value="@ViewBag.POId" />

    <div class="table-responsive">
        <table class="table table-bordered align-middle">
            <thead class="table-dark text-center">
                <tr>
                    <th style="width:50px">#</th>
                    <th>Item</th>
                    <th style="width:130px">Outstanding</th>
                    <th style="width:150px">Qty Terima</th>
                </tr>
            </thead>
            <tbody>
                @if (dt != null && dt.Rows.Count > 0)
                {
                    int i = 0;
                    foreach (DataRow r in dt.Rows)
                    {
                <tr>
                    <td class="text-center">@(++i)</td>

                    <td>
                        <strong>@r["ItemName"]</strong>
                        <input type="hidden" name="Items[@(i-1)].ItemId"
                               value="@r["ItemId"]" />
                        <input type="hidden" class="outstanding"
                               name="Items[@(i-1)].OutstandingQty"
                               value="@r["OutstandingQty"]" />
                    </td>

                    <td class="text-end">
                        <span class="badge bg-warning text-dark">
                                    @Convert.ToDecimal(r["OutstandingQty"]).ToString("N2")
                        </span>
                    </td>

                    <td>
                        <input type="number"
                               name="Items[@(i-1)].ReceiveQty"
                               class="form-control receive-qty text-end"
                               step="0.01"
                               min="0"
                               max="@r["OutstandingQty"]"
                               placeholder="0.00" />
                    </td>
                </tr>
                    }
                }
                else
                {
        <tr>
            <td colspan="4" class="text-center text-muted">
                Tidak ada item outstanding
            </td>
        </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-3">
        <a asp-action="Index" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Kembali
        </a>
        <button type="submit" class="btn btn-success">
            <i class="bi bi-check-circle"></i> Simpan GR
        </button>
    </div>
</form>
<script>
    document.getElementById("grForm").addEventListener("submit", function (e) {
        let valid = false;

        document.querySelectorAll(".receive-qty").forEach(function (input) {
            let qty = parseFloat(input.value) || 0;
            let max = parseFloat(input.getAttribute("max"));

            if (qty > max) {
                alert("Qty terima tidak boleh melebihi outstanding");
                input.focus();
                e.preventDefault();
                valid = false;
                return;
            }

            if (qty > 0) valid = true;
        });

        if (!valid) {
            alert("Isi minimal satu Qty Terima");
            e.preventDefault();
        }
    });
</script>
